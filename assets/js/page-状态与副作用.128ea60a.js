(window.webpackJsonp=window.webpackJsonp||[]).push([[521],{1143:function(t,s,a){"use strict";a.r(s);var e=a(1),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"状态与副作用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#状态与副作用"}},[t._v("#")]),t._v(" 状态与副作用")]),t._v(" "),a("p",[t._v("在前文我们已经分析了"),a("code",[t._v("fiber树")]),t._v("从"),a("code",[t._v("构造")]),t._v("到"),a("code",[t._v("渲染")]),t._v("的关键过程. 本节我们站在"),a("code",[t._v("fiber")]),t._v("对象的视角, 考虑一个具体的"),a("code",[t._v("fiber")]),t._v("节点如何影响最终的渲染.")]),t._v(" "),a("p",[t._v("回顾"),a("a",{attrs:{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactInternalTypes.js#L47-L174",target:"_blank",rel:"noopener noreferrer"}},[t._v("fiber 数据结构"),a("OutboundLink")],1),t._v(", 并结合前文"),a("code",[t._v("fiber树构造")]),t._v("系列的解读, 我们注意到"),a("code",[t._v("fiber")]),t._v("众多属性中, 有 2 类属性十分关键:")]),t._v(" "),a("ol",[a("li",[a("p",[a("code",[t._v("fiber")]),t._v("节点的自身状态: 在"),a("code",[t._v("renderRootSync[Concurrent]")]),t._v("阶段, 为子节点提供确定的输入数据, 直接影响子节点的生成.")])]),t._v(" "),a("li",[a("p",[a("code",[t._v("fiber")]),t._v("节点的副作用: 在"),a("code",[t._v("commitRoot")]),t._v("阶段, 如果"),a("code",[t._v("fiber")]),t._v("被标记有副作用, 则副作用相关函数会被(同步/异步)调用.")])])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" type Fiber "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1. fiber节点自身状态相关")]),t._v("\n  pendingProps"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" any"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  memoizedProps"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" any"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  updateQueue"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" mixed"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  memoizedState"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" any"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2. fiber节点副作用(Effect)相关")]),t._v("\n  flags"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Flags"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  subtreeFlags"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Flags"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// v17.0.2未启用")]),t._v("\n  deletions"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Array"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("Fiber"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// v17.0.2未启用")]),t._v("\n  nextEffect"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Fiber "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  firstEffect"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Fiber "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  lastEffect"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Fiber "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h2",{attrs:{id:"状态"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#状态"}},[t._v("#")]),t._v(" 状态")]),t._v(" "),a("p",[t._v("与"),a("code",[t._v("状态")]),t._v("相关有 4 个属性:")]),t._v(" "),a("ol",[a("li",[a("code",[t._v("fiber.pendingProps")]),t._v(": 输入属性, 从"),a("code",[t._v("ReactElement")]),t._v("对象传入的 props. 它和"),a("code",[t._v("fiber.memoizedProps")]),t._v("比较可以得出属性是否变动.")]),t._v(" "),a("li",[a("code",[t._v("fiber.memoizedProps")]),t._v(": 上一次生成子节点时用到的属性, 生成子节点之后保持在内存中. 向下生成子节点之前叫做"),a("code",[t._v("pendingProps")]),t._v(", 生成子节点之后会把"),a("code",[t._v("pendingProps")]),t._v("赋值给"),a("code",[t._v("memoizedProps")]),t._v("用于下一次比较."),a("code",[t._v("pendingProps")]),t._v("和"),a("code",[t._v("memoizedProps")]),t._v("比较可以得出属性是否变动.")]),t._v(" "),a("li",[a("code",[t._v("fiber.updateQueue")]),t._v(": 存储"),a("code",[t._v("update更新对象")]),t._v("的队列, 每一次发起更新, 都需要在该队列上创建一个"),a("code",[t._v("update对象")]),t._v(".")]),t._v(" "),a("li",[a("code",[t._v("fiber.memoizedState")]),t._v(": 上一次生成子节点之后保持在内存中的局部状态.")])]),t._v(" "),a("p",[t._v("它们的作用只局限于"),a("code",[t._v("fiber树构造")]),t._v("阶段, 直接影响子节点的生成.")]),t._v(" "),a("h2",{attrs:{id:"副作用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#副作用"}},[t._v("#")]),t._v(" 副作用")]),t._v(" "),a("p",[t._v("与"),a("code",[t._v("副作用")]),t._v("相关有 4 个属性:")]),t._v(" "),a("ol",[a("li",[a("code",[t._v("fiber.flags")]),t._v(": 标志位, 表明该"),a("code",[t._v("fiber")]),t._v("节点有副作用(在 v17.0.2 中共定义了"),a("a",{attrs:{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberFlags.js#L13",target:"_blank",rel:"noopener noreferrer"}},[t._v("28 种副作用"),a("OutboundLink")],1),t._v(").")]),t._v(" "),a("li",[a("code",[t._v("fiber.nextEffect")]),t._v(": 单向链表, 指向下一个副作用 "),a("code",[t._v("fiber")]),t._v("节点.")]),t._v(" "),a("li",[a("code",[t._v("fiber.firstEffect")]),t._v(": 单向链表, 指向第一个副作用 "),a("code",[t._v("fiber")]),t._v(" 节点.")]),t._v(" "),a("li",[a("code",[t._v("fiber.lastEffect")]),t._v(": 单向链表, 指向最后一个副作用 "),a("code",[t._v("fiber")]),t._v(" 节点.")])]),t._v(" "),a("p",[t._v("通过前文"),a("code",[t._v("fiber树构造")]),t._v("我们知道, 单个"),a("code",[t._v("fiber")]),t._v("节点的副作用队列最后都会上移到根节点上. 所以在"),a("code",[t._v("commitRoot")]),t._v("阶段中, "),a("code",[t._v("react")]),t._v("提供了 3 种处理副作用的方式(详见"),a("RouterLink",{attrs:{to:"/react-illustration-series/main/fibertree-commit.html#渲染"}},[t._v("fiber 树渲染")]),t._v(").")],1),t._v(" "),a("p",[t._v("另外, "),a("code",[t._v("副作用")]),t._v("的设计可以理解为对"),a("code",[t._v("状态")]),t._v("功能不足的补充.")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("状态")]),t._v("是一个"),a("code",[t._v("静态")]),t._v("的功能, 它只能为子节点提供数据源.")]),t._v(" "),a("li",[t._v("而"),a("code",[t._v("副作用")]),t._v("是一个"),a("code",[t._v("动态")]),t._v("功能, 由于它的调用时机是在"),a("code",[t._v("fiber树渲染阶段")]),t._v(", 故它拥有更多的能力, 能轻松获取"),a("code",[t._v("突变前快照, 突变后的DOM节点等")]),t._v(". 甚至通过"),a("code",[t._v("调用api")]),t._v("发起新的一轮"),a("code",[t._v("fiber树构造")]),t._v(", 进而改变更多的"),a("code",[t._v("状态")]),t._v(", 引发更多的"),a("code",[t._v("副作用")]),t._v(".")])]),t._v(" "),a("h2",{attrs:{id:"外部-api"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#外部-api"}},[t._v("#")]),t._v(" 外部 api")]),t._v(" "),a("p",[a("code",[t._v("fiber")]),t._v("对象的这 2 类属性, 可以影响到渲染结果, 但是"),a("code",[t._v("fiber")]),t._v("结构始终是一个内核中的结构, 对于外部来讲是无感知的, 对于调用方来讲, 甚至都无需知道"),a("code",[t._v("fiber")]),t._v("结构的存在. 所以正常只有通过暴露"),a("code",[t._v("api")]),t._v("来直接或间接的修改这 2 类属性.")]),t._v(" "),a("p",[t._v("从"),a("code",[t._v("react")]),t._v("包暴露出的"),a("code",[t._v("api")]),t._v("来归纳, 只有 2 类组件支持修改:")]),t._v(" "),a("blockquote",[a("p",[t._v("本节只讨论使用"),a("code",[t._v("api")]),t._v("的目的是修改"),a("code",[t._v("fiber")]),t._v("的"),a("code",[t._v("状态")]),t._v("和"),a("code",[t._v("副作用")]),t._v(", 进而可以改变整个渲染结果. 本节先介绍 api 与"),a("code",[t._v("状态")]),t._v("和"),a("code",[t._v("副作用")]),t._v("的联系, 有关"),a("code",[t._v("api")]),t._v("的具体实现会在"),a("code",[t._v("class组件")]),t._v(","),a("code",[t._v("Hook原理")]),t._v("章节中详细分析.")])]),t._v(" "),a("h3",{attrs:{id:"class-组件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#class-组件"}},[t._v("#")]),t._v(" class 组件")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("App")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("React"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Component")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("constructor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 初始状态")]),t._v("\n      a"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("changeState")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setState")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" a"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("a "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 进入reconciler流程")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 生命周期函数: 状态相关")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getDerivedStateFromProps")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("nextProps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" prevState")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'getDerivedStateFromProps'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" prevState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 生命周期函数: 状态相关")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("shouldComponentUpdate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("newProps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" newState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" nextContext")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'shouldComponentUpdate'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 生命周期函数: 副作用相关 fiber.flags |= Update")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("componentDidMount")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'componentDidMount'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 生命周期函数: 副作用相关 fiber.flags |= Snapshot")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getSnapshotBeforeUpdate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("prevProps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" prevState")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'getSnapshotBeforeUpdate'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 生命周期函数: 副作用相关 fiber.flags |= Update")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("componentDidUpdate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'componentDidUpdate'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 返回下级ReactElement对象")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("button onClick"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("changeState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("button"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("ol",[a("li",[a("p",[t._v("状态相关: "),a("code",[t._v("fiber树构造")]),t._v("阶段.")]),t._v(" "),a("ol",[a("li",[t._v("构造函数: "),a("code",[t._v("constructor")]),t._v("实例化时执行, 可以设置初始 state, 只执行一次.")]),t._v(" "),a("li",[t._v("生命周期: "),a("code",[t._v("getDerivedStateFromProps")]),t._v("在"),a("code",[t._v("fiber树构造")]),t._v("阶段("),a("code",[t._v("renderRootSync[Concurrent]")]),t._v(")执行, 可以修改 state("),a("a",{attrs:{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberClassComponent.old.js#L867-L875",target:"_blank",rel:"noopener noreferrer"}},[t._v("链接"),a("OutboundLink")],1),t._v(").")]),t._v(" "),a("li",[t._v("生命周期: "),a("code",[t._v("shouldComponentUpdate")]),t._v("在, "),a("code",[t._v("fiber树构造")]),t._v("阶段("),a("code",[t._v("renderRootSync[Concurrent]")]),t._v(")执行, 返回值决定是否执行 render("),a("a",{attrs:{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberClassComponent.old.js#L1135-L1143",target:"_blank",rel:"noopener noreferrer"}},[t._v("链接"),a("OutboundLink")],1),t._v(").")])])]),t._v(" "),a("li",[a("p",[t._v("副作用相关: "),a("code",[t._v("fiber树渲染")]),t._v("阶段.")]),t._v(" "),a("ol",[a("li",[t._v("生命周期: "),a("code",[t._v("getSnapshotBeforeUpdate")]),t._v("在"),a("code",[t._v("fiber树渲染")]),t._v("阶段("),a("code",[t._v("commitRoot->commitBeforeMutationEffects->commitBeforeMutationEffectOnFiber")]),t._v(")执行("),a("a",{attrs:{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberCommitWork.old.js#L264",target:"_blank",rel:"noopener noreferrer"}},[t._v("链接"),a("OutboundLink")],1),t._v(").")]),t._v(" "),a("li",[t._v("生命周期: "),a("code",[t._v("componentDidMount")]),t._v("在"),a("code",[t._v("fiber树渲染")]),t._v("阶段("),a("code",[t._v("commitRoot->commitLayoutEffects->commitLayoutEffectOnFiber")]),t._v(")执行("),a("a",{attrs:{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberCommitWork.old.js#L533",target:"_blank",rel:"noopener noreferrer"}},[t._v("链接"),a("OutboundLink")],1),t._v(").")]),t._v(" "),a("li",[t._v("生命周期: "),a("code",[t._v("componentDidUpdate")]),t._v("在"),a("code",[t._v("fiber树渲染")]),t._v("阶段("),a("code",[t._v("commitRoot->commitLayoutEffects->commitLayoutEffectOnFiber")]),t._v(")执行("),a("a",{attrs:{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberCommitWork.old.js#L587",target:"_blank",rel:"noopener noreferrer"}},[t._v("链接"),a("OutboundLink")],1),t._v(").")])])])]),t._v(" "),a("p",[t._v("可以看到, 官方"),a("code",[t._v("api")]),t._v("提供的"),a("code",[t._v("class组件")]),t._v("生命周期函数实际上也是围绕"),a("code",[t._v("fiber树构造")]),t._v("和"),a("code",[t._v("fiber树渲染")]),t._v("来提供的.")]),t._v(" "),a("h3",{attrs:{id:"function-组件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#function-组件"}},[t._v("#")]),t._v(" function 组件")]),t._v(" "),a("p",[t._v("注: "),a("code",[t._v("function组件")]),t._v("与"),a("code",[t._v("class组件")]),t._v("最大的不同是: "),a("code",[t._v("class组件")]),t._v("会实例化一个"),a("code",[t._v("instance")]),t._v("所以拥有独立的局部状态; 而"),a("code",[t._v("function组件")]),t._v("不会实例化, 它只是被直接调用, 故无法维护一份独立的局部状态, 只能依靠"),a("code",[t._v("Hook")]),t._v("对象间接实现局部状态(有关更多"),a("code",[t._v("Hook")]),t._v("实现细节, 在"),a("code",[t._v("Hook原理")]),t._v("章节中详细讨论).")]),t._v(" "),a("p",[t._v("在"),a("code",[t._v("v17.0.2")]),t._v("中共定义了"),a("a",{attrs:{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L111-L125",target:"_blank",rel:"noopener noreferrer"}},[t._v("14 种 Hook"),a("OutboundLink")],1),t._v(", 其中最常用的"),a("code",[t._v("useState, useEffect, useLayoutEffect等")])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("App")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 状态相关: 初始状态")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" setA"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("useState")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("changeState")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setA")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v("a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 进入reconciler流程")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 副作用相关: fiber.flags |= Update | Passive;")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("useEffect")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("useEffect")]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 副作用相关: fiber.flags |= Update;")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("useLayoutEffect")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("useLayoutEffect")]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 返回下级ReactElement对象")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("button onClick"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("changeState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("button"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("ol",[a("li",[t._v("状态相关: "),a("code",[t._v("fiber树构造")]),t._v("阶段.\n"),a("ol",[a("li",[a("code",[t._v("useState")]),t._v("在"),a("code",[t._v("fiber树构造")]),t._v("阶段("),a("code",[t._v("renderRootSync[Concurrent]")]),t._v(")执行, 可以修改"),a("code",[t._v("Hook.memoizedState")]),t._v(".")])])]),t._v(" "),a("li",[t._v("副作用相关: "),a("code",[t._v("fiber树渲染")]),t._v("阶段.\n"),a("ol",[a("li",[a("code",[t._v("useEffect")]),t._v("在"),a("code",[t._v("fiber树渲染")]),t._v("阶段("),a("code",[t._v("commitRoot->commitBeforeMutationEffects->commitBeforeMutationEffectOnFiber")]),t._v(")执行(注意是异步执行, "),a("a",{attrs:{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L2290-L2295",target:"_blank",rel:"noopener noreferrer"}},[t._v("链接"),a("OutboundLink")],1),t._v(").")]),t._v(" "),a("li",[a("code",[t._v("useLayoutEffect")]),t._v("在"),a("code",[t._v("fiber树渲染")]),t._v("阶段("),a("code",[t._v("commitRoot->commitLayoutEffects->commitLayoutEffectOnFiber->commitHookEffectListMount")]),t._v(")执行(同步执行, "),a("a",{attrs:{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberCommitWork.old.js#L481",target:"_blank",rel:"noopener noreferrer"}},[t._v("链接"),a("OutboundLink")],1),t._v(").")])])])]),t._v(" "),a("h3",{attrs:{id:"细节与误区"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#细节与误区"}},[t._v("#")]),t._v(" 细节与误区")]),t._v(" "),a("p",[t._v("这里有 2 个细节:")]),t._v(" "),a("ol",[a("li",[a("code",[t._v("useEffect(function(){}, [])")]),t._v("中的函数是"),a("a",{attrs:{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L2290-L2295",target:"_blank",rel:"noopener noreferrer"}},[t._v("异步执行"),a("OutboundLink")],1),t._v(", 因为它经过了调度中心(具体实现可以回顾"),a("RouterLink",{attrs:{to:"/react-illustration-series/main/scheduler.html"}},[t._v("调度原理")]),t._v(").")],1),t._v(" "),a("li",[a("code",[t._v("useLayoutEffect")]),t._v("和"),a("code",[t._v("Class组件")]),t._v("中的"),a("code",[t._v("componentDidMount,componentDidUpdate")]),t._v("从调用时机上来讲是等价的, 因为他们都在"),a("code",[t._v("commitRoot->commitLayoutEffects")]),t._v("函数中被调用.\n"),a("ul",[a("li",[t._v("误区: 虽然官网文档推荐尽可能使用标准的 "),a("code",[t._v("useEffect")]),t._v(" 以避免阻塞视觉更新 , 所以很多开发者使用"),a("code",[t._v("useEffect")]),t._v("来代替"),a("code",[t._v("componentDidMount,componentDidUpdate")]),t._v("是不准确的, 如果完全类比, "),a("code",[t._v("useLayoutEffect")]),t._v("比"),a("code",[t._v("useEffect")]),t._v("更符合"),a("code",[t._v("componentDidMount,componentDidUpdate")]),t._v("的定义.")])])])]),t._v(" "),a("p",[t._v("为了验证上述结论, 可以查看"),a("a",{attrs:{href:"https://codesandbox.io/s/fervent-napier-1ysb5",target:"_blank",rel:"noopener noreferrer"}},[t._v("codesandbox 中的例子"),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("h2",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),a("p",[t._v("本节从"),a("code",[t._v("fiber")]),t._v("视角出发, 总结了"),a("code",[t._v("fiber")]),t._v("节点中可以影响最终渲染结果的 2 类属性("),a("code",[t._v("状态")]),t._v("和"),a("code",[t._v("副作用")]),t._v(").并且归纳了"),a("code",[t._v("class")]),t._v("和"),a("code",[t._v("function")]),t._v("组件中, 直接或间接更改"),a("code",[t._v("fiber")]),t._v("属性的常用方式. 最后从"),a("code",[t._v("fiber树构造和渲染")]),t._v("的角度对"),a("code",[t._v("class的生命周期函数")]),t._v("与"),a("code",[t._v("function的Hooks函数")]),t._v("进行了比较.")])])}),[],!1,null,null,null);s.default=n.exports}}]);