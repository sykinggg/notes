(window.webpackJsonp=window.webpackJsonp||[]).push([[417],{820:function(t,n,s){"use strict";s.r(n);var e=s(1),a=Object(e.a)({},(function(){var t=this,n=t.$createElement,s=t._self._c||n;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:""}},[s("a",{staticClass:"header-anchor",attrs:{href:"#"}},[t._v("#")])]),t._v(" "),s("h1",{attrs:{id:"事件模块的注入模式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#事件模块的注入模式"}},[t._v("#")]),t._v(" 事件模块的注入模式")]),t._v(" "),s("p",[t._v("React 为了跨平台，对于事件体系的代码做出了一些妥协，采用动态注入的方式让不同的平台对事件核心模块进行插件注入。先来看"),s("code",[t._v("ReactDOM")]),t._v("的入口文件，里面有这么一句代码："),s("code",[t._v("import './ReactDOMClientInjection';")]),t._v("，这就是注入的开始，这个 js 的代码如下：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" EventPluginHub "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'events/EventPluginHub'")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" EventPluginUtils "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'events/EventPluginUtils'")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  getFiberCurrentPropsFromNode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  getInstanceFromNode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  getNodeFromInstance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./ReactDOMComponentTree'")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" BeforeInputEventPlugin "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'../events/BeforeInputEventPlugin'")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" ChangeEventPlugin "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'../events/ChangeEventPlugin'")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" DOMEventPluginOrder "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'../events/DOMEventPluginOrder'")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" EnterLeaveEventPlugin "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'../events/EnterLeaveEventPlugin'")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" SelectEventPlugin "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'../events/SelectEventPlugin'")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" SimpleEventPlugin "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'../events/SimpleEventPlugin'")]),t._v("\n\nEventPluginHub"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("injection"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("injectEventPluginOrder")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("DOMEventPluginOrder"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nEventPluginUtils"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setComponentTree")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  getFiberCurrentPropsFromNode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  getInstanceFromNode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  getNodeFromInstance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nEventPluginHub"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("injection"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("injectEventPluginsByName")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  SimpleEventPlugin"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" SimpleEventPlugin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  EnterLeaveEventPlugin"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" EnterLeaveEventPlugin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  ChangeEventPlugin"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ChangeEventPlugin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  SelectEventPlugin"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" SelectEventPlugin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  BeforeInputEventPlugin"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" BeforeInputEventPlugin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("通过这两个方法向事件系统注入了平台相关的事件代码，同时确定事件的调用顺序。")]),t._v(" "),s("h1",{attrs:{id:"plugin"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#plugin"}},[t._v("#")]),t._v(" plugin")]),t._v(" "),s("p",[t._v("先来看一下一个"),s("code",[t._v("plugin")]),t._v("应该长咋样：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" ChangeEventPlugin "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  eventTypes"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    change"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      phasedRegistrationNames"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        bubbled"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'onChange'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        captured"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'onChangeCapture'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      isInteractive"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" boolean"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 标志是否高优先级反馈")]),t._v("\n      registrationName"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" string"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      dependencies"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("TOP_BLUR")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("TOP_CHANGE")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("TOP_CLICK")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("TOP_FOCUS")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("TOP_INPUT")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("TOP_KEY_DOWN")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("TOP_KEY_UP")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("TOP_SELECTION_CHANGE")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\n  _isInputEventSupported"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" isInputEventSupported"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("extractEvents")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("topLevelType"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    targetInst"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    nativeEvent"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    nativeEventTarget"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建event对象并return")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[s("code",[t._v("eventTypes")]),t._v("是以具体事件为"),s("code",[t._v("key")]),t._v("的 "),s("strong",[t._v("map")]),t._v(" 对象，其中每个事件的"),s("code",[t._v("phasedRegistrationNames")]),t._v("是指定"),s("code",[t._v("props")]),t._v("的名字，"),s("code",[t._v("dependencies")]),t._v("是如果需要绑定"),s("code",[t._v("change")]),t._v("事件需要同时绑定哪些事件")]),t._v(" "),s("p",[s("code",[t._v("extractEvents")]),t._v("是一个方法，用来根据具体真实触发的事件类型等参数，返回对应的事件对象，也可以返回"),s("code",[t._v("null")]),t._v("表示当前事件跟这个插件没有关系。")]),t._v(" "),s("h1",{attrs:{id:"注册插件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#注册插件"}},[t._v("#")]),t._v(" 注册插件")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("变量名")]),t._v(" "),s("th",[t._v("作用")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[s("code",[t._v("eventPluginOrder")])]),t._v(" "),s("td",[t._v("记录插件的调用顺序")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("namesToPlugins")])]),t._v(" "),s("td",[t._v("以插件名为key的插件 map")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("plugins")])]),t._v(" "),s("td",[t._v("按照"),s("code",[t._v("eventPluginOrder")]),t._v("顺序存储的插件模块数组")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("eventNameDispatchConfigs")])]),t._v(" "),s("td",[t._v("按照每个插件中的"),s("code",[t._v("eventTypes")]),t._v("中的每一项为"),s("code",[t._v("key")]),t._v("，其对应的对象为"),s("code",[t._v("value")]),t._v("的对象")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("registrationNameModules")])]),t._v(" "),s("td",[t._v("存储有"),s("code",[t._v("phasedRegistrationNames")]),t._v("或者"),s("code",[t._v("registrationName")]),t._v("的插件的事件对应的模块")])])])]),t._v(" "),s("ol",[s("li",[s("p",[t._v("首先调用"),s("code",[t._v("injectEventPluginOrder")]),t._v("，设置"),s("code",[t._v("eventPluginOrder")])])]),t._v(" "),s("li",[s("p",[t._v("然后调用"),s("code",[t._v("injectEventPluginsByName")]),t._v("，把所有插件加入到"),s("code",[t._v("namesToPlugins")]),t._v("对象中，并以插件名为"),s("code",[t._v("key")])])]),t._v(" "),s("li",[s("p",[t._v("然后调用"),s("code",[t._v("recomputePluginOrdering")]),t._v("把所有插件安顺序插入到"),s("code",[t._v("plugins")]),t._v("数组中，并对每个插件中的"),s("code",[t._v("eventTypes")]),t._v("中的每个事件类型调用"),s("code",[t._v("publishEventForPlugin")]),t._v("，设置"),s("code",[t._v("eventNameDispatchConfigs")]),t._v("对象，以事件名为"),s("code",[t._v("key")]),t._v("存储"),s("code",[t._v("dispatchConfig")]),t._v("，也就是上面插件中的"),s("code",[t._v("eventTypes.change")]),t._v("对应的对象")])]),t._v(" "),s("li",[s("p",[t._v("然后还需要对每一个"),s("code",[t._v("phasedRegistrationNames")]),t._v("里面的项执行"),s("code",[t._v("publishRegistrationName")]),t._v("，设置"),s("code",[t._v("registrationNameModules")]),t._v("，以事件名为"),s("code",[t._v("key")]),t._v("存储模块，同时设置"),s("code",[t._v("registrationNameDependencies")]),t._v("，以事件名为"),s("code",[t._v("key")]),t._v("存储事件的"),s("code",[t._v("dependencies")])])])]),t._v(" "),s("p",[s("code",[t._v("registrationNameModules")]),t._v("在更新 DOM 节点的时候会被用到，"),s("code",[t._v("registrationNameDependencies")]),t._v("在绑定事件的使用会被用到。")]),t._v(" "),s("p",[t._v("整个注册过程就是为了初始化设置这些变量，这些变量在后续的 DOM 操作中会扮演比较重要的角色。")]),t._v(" "),s("h1",{attrs:{id:"结构"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#结构"}},[t._v("#")]),t._v(" 结构")]),t._v(" "),s("p",[s("strong",[t._v("eventNameDispatchConfigs")])]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  change"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ChangePlugin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("eventTypes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("change"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...other plugins")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[s("strong",[t._v("registrationNameModules")])]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  onChange"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ChangePlugin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  onChangeCapture"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ChangePlugin\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[s("strong",[t._v("registrationNameDependencies")])]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  onChange"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ChangePlugin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("eventTypes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("change"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dependencies"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  onChangeCapture"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ChangePlugin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("eventTypes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("change"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dependencies\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])])}),[],!1,null,null,null);n.default=a.exports}}]);