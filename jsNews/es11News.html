<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.36">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>2022 新特性提案 | </title><meta name="description" content="君子藏器于身 待时而动 天下有道则见 无道则隐">
    <link rel="modulepreload" href="/notes/assets/app.816e2a4d.js"><link rel="modulepreload" href="/notes/assets/es11News.html.8227fc8f.js"><link rel="modulepreload" href="/notes/assets/es11News.html.d0d00e5b.js">
    <link rel="stylesheet" href="/notes/assets/style.3c840394.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/notes/" class=""><img class="logo" src="https://vuejs.org/images/logo.png" alt><!----></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="技术"><span class="title">技术</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="技术"><span class="title">技术</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/technology/base.md" class="" aria-label="技术前瞻"><!--[--><!--]--> 技术前瞻 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="js"><span class="title">js</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="js"><span class="title">js</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/mozillajs/baseObject/symbol.md" class="" aria-label="mozilla：基本对象"><!--[--><!--]--> mozilla：基本对象 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/jsInterview/baseInterview.md" class="" aria-label="基础面试题"><!--[--><!--]--> 基础面试题 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/js/stack/executionStack.md" class="" aria-label="js 概念"><!--[--><!--]--> js 概念 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/ts/jsx/support" class="" aria-label="JSX"><!--[--><!--]--> JSX <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/ts/project/inDepthTs.md" class="" aria-label="TypeScript 项目"><!--[--><!--]--> TypeScript 项目 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/jsNews/es6News.md" class="" aria-label="js 新概念"><!--[--><!--]--> js 新概念 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="css"><span class="title">css</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="css"><span class="title">css</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/mozillaCss/reference/universalSelectors.md" class="" aria-label="第 1 期：CSS API"><!--[--><!--]--> 第 1 期：CSS API <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/css/interview/baseCss.md" class="" aria-label="零散记录"><!--[--><!--]--> 零散记录 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="html"><span class="title">html</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="html"><span class="title">html</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/html/interview/linkImport.md" class="" aria-label="零散记录"><!--[--><!--]--> 零散记录 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="端"><span class="title">端</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="端"><span class="title">端</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/browser/interview/baseInterview.md" class="" aria-label="基础浏览器"><!--[--><!--]--> 基础浏览器 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/http/interview/baseInterview.md" class="" aria-label="基础http"><!--[--><!--]--> 基础http <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="工具"><span class="title">工具</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="工具"><span class="title">工具</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/webpack/interview/webpackInterview.md" class="" aria-label="webpack"><!--[--><!--]--> webpack <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/esbuild/description.md" class="" aria-label="esbuild"><!--[--><!--]--> esbuild <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/rollup/introduction.md" class="" aria-label="rollup"><!--[--><!--]--> rollup <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/git/indx.md" class="" aria-label="git"><!--[--><!--]--> git <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/nginx/base.md" class="" aria-label="nginx"><!--[--><!--]--> nginx <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/cli/base.md" class="" aria-label="cli"><!--[--><!--]--> cli <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/npm/commonlyUsed.md" class="" aria-label="npm"><!--[--><!--]--> npm <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="react"><span class="title">react</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="react"><span class="title">react</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/ILoveDevelop/react/principle/base.md" class="" aria-label="react 源码阅读 代码视角"><!--[--><!--]--> react 源码阅读 代码视角 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/react/preparation/idea.md" class="" aria-label="react 源码阅读 思想视角"><!--[--><!--]--> react 源码阅读 思想视角 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/react-illustration-series/main/macro-structure.md" class="" aria-label="图解React源码"><!--[--><!--]--> 图解React源码 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/umi/interview/pluginDva.md" class="" aria-label="umi"><!--[--><!--]--> umi <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/reactInterview/interview1.md" class="" aria-label="整理"><!--[--><!--]--> 整理 <!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="技术"><span class="title">技术</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="技术"><span class="title">技术</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/technology/base.md" class="" aria-label="技术前瞻"><!--[--><!--]--> 技术前瞻 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="js"><span class="title">js</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="js"><span class="title">js</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/mozillajs/baseObject/symbol.md" class="" aria-label="mozilla：基本对象"><!--[--><!--]--> mozilla：基本对象 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/jsInterview/baseInterview.md" class="" aria-label="基础面试题"><!--[--><!--]--> 基础面试题 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/js/stack/executionStack.md" class="" aria-label="js 概念"><!--[--><!--]--> js 概念 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/ts/jsx/support" class="" aria-label="JSX"><!--[--><!--]--> JSX <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/ts/project/inDepthTs.md" class="" aria-label="TypeScript 项目"><!--[--><!--]--> TypeScript 项目 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/jsNews/es6News.md" class="" aria-label="js 新概念"><!--[--><!--]--> js 新概念 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="css"><span class="title">css</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="css"><span class="title">css</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/mozillaCss/reference/universalSelectors.md" class="" aria-label="第 1 期：CSS API"><!--[--><!--]--> 第 1 期：CSS API <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/css/interview/baseCss.md" class="" aria-label="零散记录"><!--[--><!--]--> 零散记录 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="html"><span class="title">html</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="html"><span class="title">html</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/html/interview/linkImport.md" class="" aria-label="零散记录"><!--[--><!--]--> 零散记录 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="端"><span class="title">端</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="端"><span class="title">端</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/browser/interview/baseInterview.md" class="" aria-label="基础浏览器"><!--[--><!--]--> 基础浏览器 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/http/interview/baseInterview.md" class="" aria-label="基础http"><!--[--><!--]--> 基础http <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="工具"><span class="title">工具</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="工具"><span class="title">工具</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/webpack/interview/webpackInterview.md" class="" aria-label="webpack"><!--[--><!--]--> webpack <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/esbuild/description.md" class="" aria-label="esbuild"><!--[--><!--]--> esbuild <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/rollup/introduction.md" class="" aria-label="rollup"><!--[--><!--]--> rollup <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/git/indx.md" class="" aria-label="git"><!--[--><!--]--> git <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/nginx/base.md" class="" aria-label="nginx"><!--[--><!--]--> nginx <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/cli/base.md" class="" aria-label="cli"><!--[--><!--]--> cli <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/npm/commonlyUsed.md" class="" aria-label="npm"><!--[--><!--]--> npm <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="react"><span class="title">react</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="react"><span class="title">react</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/ILoveDevelop/react/principle/base.md" class="" aria-label="react 源码阅读 代码视角"><!--[--><!--]--> react 源码阅读 代码视角 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/react/preparation/idea.md" class="" aria-label="react 源码阅读 思想视角"><!--[--><!--]--> react 源码阅读 思想视角 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/react-illustration-series/main/macro-structure.md" class="" aria-label="图解React源码"><!--[--><!--]--> 图解React源码 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/umi/interview/pluginDva.md" class="" aria-label="umi"><!--[--><!--]--> umi <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/reactInterview/interview1.md" class="" aria-label="整理"><!--[--><!--]--> 整理 <!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">js 版本 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/notes/jsNews/es6News.html" class="sidebar-item" aria-label="ES6新特性（2015）"><!--[--><!--]--> ES6新特性（2015） <!--[--><!--]--></a><!----></li><li><a href="/notes/jsNews/es7News.html" class="sidebar-item" aria-label="ES7新特性（2016）"><!--[--><!--]--> ES7新特性（2016） <!--[--><!--]--></a><!----></li><li><a href="/notes/jsNews/es8News.html" class="sidebar-item" aria-label="ES8新特性（2017）"><!--[--><!--]--> ES8新特性（2017） <!--[--><!--]--></a><!----></li><li><a href="/notes/jsNews/es9News.html" class="sidebar-item" aria-label="ES9新特性（2018）"><!--[--><!--]--> ES9新特性（2018） <!--[--><!--]--></a><!----></li><li><a href="/notes/jsNews/es10News.html" class="sidebar-item" aria-label="ES10新特性（2019）"><!--[--><!--]--> ES10新特性（2019） <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading">js 版本 衍生 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/notes/jsNews/es6Interview1.html" class="sidebar-item" aria-label="Modular design (模块化设计)"><!--[--><!--]--> Modular design (模块化设计) <!--[--><!--]--></a><!----></li><li><a href="/notes/jsNews/es6Interview2.html" class="sidebar-item" aria-label="详解箭头函数和普通函数的区别以及箭头函数的注意事项、不适用场景"><!--[--><!--]--> 详解箭头函数和普通函数的区别以及箭头函数的注意事项、不适用场景 <!--[--><!--]--></a><!----></li><li><a href="/notes/jsNews/es6Interview3.html" class="sidebar-item" aria-label="module、export、import分别有什么作用？"><!--[--><!--]--> module、export、import分别有什么作用？ <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="_2022-新特性提案" tabindex="-1"><a class="header-anchor" href="#_2022-新特性提案" aria-hidden="true">#</a> 2022 新特性提案</h1><h2 id="_1-error-cause" tabindex="-1"><a class="header-anchor" href="#_1-error-cause" aria-hidden="true">#</a> 1. error.cause</h2><p>这是一个关于错误捕获的特性，下文代码列举了过去我们常使用的三种捕获错误的方式。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">doJob</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> rawResource <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&#39;/test&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 下面三种是过去常用的一些捕获错误的代码方式</span>
      
      <span class="token comment">// 1. throw new Error(&#39;下载资源失败: &#39; + err.message);</span>
      
      <span class="token comment">// 2. const wrapErr = new Error(&#39;下载资源失败&#39;);</span>
      <span class="token comment">//    wrapErr.cause = err;</span>
      <span class="token comment">//    throw wrapErr;</span>
      
      <span class="token comment">// 3. class CustomError extends Error {</span>
      <span class="token comment">//      constructor(msg, cause) {</span>
      <span class="token comment">//        super(msg);</span>
      <span class="token comment">//        this.cause = cause;</span>
      <span class="token comment">//      }</span>
      <span class="token comment">//    }</span>
      <span class="token comment">//    throw new CustomError(&#39;下载资源失败&#39;, err);</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">await</span> <span class="token function">doJob</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// =&gt; Uncaught Error: 下载资源失败: Failed to fetch</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>过去的捕获错误的写法比较复杂，而且开发人员对具体使用哪个属性来获取错误的上下文没有达成共识。</p><p>新特性是在 <code>Error</code> 构造函数上添加一个附加选项参数 <code>cause</code>，其值将作为属性分配给错误实例。因此，可以将错误链接起来。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">doJob</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> rawResource <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&#39;/test&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;下载资源失败&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">cause</span><span class="token operator">:</span> err <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">doJob</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Caused by&#39;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// Error: 下载资源失败</span>
<span class="token comment">// Caused by TypeError: Failed to fetch</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="_2-top-level-await" tabindex="-1"><a class="header-anchor" href="#_2-top-level-await" aria-hidden="true">#</a> 2. Top-level await</h2><p>我们现在可以在模块的顶层使用 <code>await</code>， 并且不再需要配合 <code>async</code>函数使用。</p><p><code>Top-level await</code> 可以在实际生产中有以下用途。</p><ul><li>动态加载模块</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> strings <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/i18n/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>navigator<span class="token punctuation">.</span>language<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>这允许模块使用运行时值来确定依赖关系。这对于开发/生产拆分、国际化、环境拆分等非常有用。</p><ul><li>资源初始化</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> connection <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">dbConnector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>允许模块表示资源。</p><ul><li>依赖回退</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> jQuery<span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  jQuery <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&#39;https://cdn-a.com/jQuery&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
  jQuery <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&#39;https://cdn-b.com/jQuery&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>依赖发生故障时，可以回退到旧版本，防止程序崩溃。</p><h2 id="_3-object-hasown-obj-propkey" tabindex="-1"><a class="header-anchor" href="#_3-object-hasown-obj-propkey" aria-hidden="true">#</a> 3. Object.hasOwn(obj, propKey)</h2><p><code>Object.hasOwn()</code> 方法是比 <code>Object.prototype.hasOwnProperty()</code> 方法更加 <strong>便捷</strong> 和 <strong>安全</strong> 的策略。</p><p>例如 <code>Object.create(null)</code> 创建一个不继承自 <code>Object.prototype</code> 的对象，使 <code>hasOwnProperty</code> 方法无法访问。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// Uncaught TypeError: Object.create(...).hasOwnProperty is not a function</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>Object.hasOwn(obj, propKey)</strong> 使用案例。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
Object<span class="token punctuation">.</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span> <span class="token comment">// true</span>

<span class="token keyword">let</span> object2 <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
Object<span class="token punctuation">.</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>object2<span class="token punctuation">,</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span> <span class="token comment">// false</span>

<span class="token keyword">let</span> object3 <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
Object<span class="token punctuation">.</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>object3<span class="token punctuation">,</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span> <span class="token comment">// false</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="_4-regexp-match-indices" tabindex="-1"><a class="header-anchor" href="#_4-regexp-match-indices" aria-hidden="true">#</a> 4. RegExp match indices</h2><p>正则表达式，继 <code>/i</code> <code>/m</code> <code>/g</code> 之后，在匹配模式上新加入了 <code>/d</code>,使用 <code>/d</code> 之后，当我们再使用<code>exec()</code> 方法时，返回值会增加一个新的属性 <code>indices</code>。</p><p>简单回顾下<code>exec()</code> 方法。</p><p>相比于常见的 <code>search()</code> <code>test()</code>而言，<code>exec()</code> 匹配字符串的信息更丰富，它返回一个数组，其中存放匹配的结果，如果未找到匹配，则返回值为 null</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> regx <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">a+(?&lt;Z&gt;z)?</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span> 
<span class="token keyword">let</span> string <span class="token operator">=</span> <span class="token string">&quot;xaaaz&quot;</span>
<span class="token keyword">let</span> result <span class="token operator">=</span> regx<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// [&#39;aaaz&#39;, &#39;z&#39;, index: 1, input: &#39;xaaaz&#39;, groups: {Z:&#39;z&#39;}]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>(?&lt;name&gt;)</code>是 <strong>ES 2018</strong> 加入的正则语法，允许我们把部分正则内容进行 <code>命名</code> 并且 <code>分组</code>，上述例子中，<code>/a+(?&lt;Z&gt;z)?/g</code>表示匹配至少一个 <strong>a</strong> 以及 <strong>0</strong> 个或者 <strong>1</strong> 个 <strong>z</strong> ，其中包含一个命名为 <strong>Z</strong> 的捕获组，配合 <code>exec()</code> 方法使用时，我们可以直接获取到捕获组的信息：<code>result.groups</code>，如果正则中没用使用捕获组的正则语法，则 <strong>groups</strong> 为 <strong>undefined</strong></p><p>尽管 <code>exec()</code> 返回值提供了 <strong>index 属性</strong> 来展示首次匹配的索引位置，<strong>groups 属性</strong> 提供了捕获组的信息，但在一些更高级的场景中，这些信息可能并不足够。例如，<strong>语法高亮显示</strong> 的实现不仅需要匹配的索引，还需要单个捕获组的开始和结束索引，即上述例子中 <code>Z</code> 捕获组的索引信息。</p><p>新特性中，使用 <code>/d</code>匹配模式时，<code>exec()</code> 方法的返回值会增加一个新的属性 <code>indices</code>。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> re <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">a+(?&lt;Z&gt;z)?</span><span class="token regex-delimiter">/</span><span class="token regex-flags">d</span></span><span class="token punctuation">;</span>
<span class="token keyword">const</span> s <span class="token operator">=</span> <span class="token string">&quot;xaaaz&quot;</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;匹配结果：&quot;</span><span class="token punctuation">,</span> re<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//[&#39;aaaz&#39;, &#39;z&#39;, index: 1, input: &#39;xaaaz&#39;, groups: {Z:&#39;z&#39;}, indices: [[1,5],[4,5]]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>indices</code>属性包含了捕获组的信息，其中，<strong>[ 1 , 5 ]</strong> 为 <code>aaaz</code> 全部字符串的匹配信息，<strong>[ 4 , 5 ]</strong> 为 <code>Z</code> 捕获组的匹配索引信息。</p><h2 id="_5-new-members-of-classes" tabindex="-1"><a class="header-anchor" href="#_5-new-members-of-classes" aria-hidden="true">#</a> 5. New members of classes</h2><ul><li>简易变量声明</li></ul><p><strong>class</strong> 支持在 <code>constructor</code> 外部直接声明变量，过去我们必须在内部声明。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Cat</span> <span class="token punctuation">{</span>
  gender <span class="token operator">=</span> <span class="token string">&#39;female&#39;</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> cat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
cat<span class="token punctuation">.</span>gender <span class="token comment">// female</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>私有变量和私有方法</li></ul><p>封装是面向对象编程的核心原则之一。它通常使用可见性修饰符来实现，例如 <code>private</code> or <code>public</code>。</p><p><strong>class</strong> 的最近改动里加入了 <code>#</code>，用来将类中的变量、方法或访问器标记为私有，从外部访问私有化的内容，会直接报错。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Cat</span> <span class="token punctuation">{</span>
  #name <span class="token operator">=</span> <span class="token string">&#39;kitty&#39;</span>
  gender <span class="token operator">=</span> <span class="token string">&#39;female&#39;</span>

  <span class="token function-variable function">setName</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>#name <span class="token operator">=</span> <span class="token string">&#39;jack&#39;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>#name<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">#setGender</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>gender<span class="token operator">=</span> <span class="token string">&#39;male&#39;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> cat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
cat<span class="token punctuation">.</span>#name <span class="token comment">// SyntaxError</span>
cat<span class="token punctuation">.</span>gender <span class="token comment">// &#39;female&#39;</span>
cat<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// &#39;jack&#39;</span>
cat<span class="token punctuation">.</span>#setGender <span class="token comment">// SyntaxError</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><ul><li>私有字段的存在性检查</li></ul><p>由于尝试访问对象上不存在的私有字段会报错从而引发程序异常，因此需要能够检查对象是否具有给定的私有字段。</p><p><strong>class</strong> 引入了关键词 <code>in</code> 来解决访问私有变量直接报错的问题。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Example</span> <span class="token punctuation">{</span>
  #field

  <span class="token keyword">static</span> <span class="token function">isExampleInstance</span><span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> #field <span class="token keyword">in</span> object<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> ex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Example</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
Example<span class="token punctuation">.</span><span class="token function">isExampleInstance</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span> <span class="token comment">// true</span>
Example<span class="token punctuation">.</span><span class="token function">isExampleInstance</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// false</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><code>isExampleInstance</code> 方法可以判断 <code>object</code> 是否包含 <code>#field</code>。</p><h2 id="_6-at" tabindex="-1"><a class="header-anchor" href="#_6-at" aria-hidden="true">#</a> 6. at（）</h2><p><code>.at()</code>支持我们读取给定索引处的元素。它可以接受<code>负索引</code>来从给定数据类型的<code>末尾</code>读取元素。</p><p>过去我们需要这样来获取数组末尾元素：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
arr<span class="token punctuation">[</span>arr<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment">// 5</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>现在 <code>at()</code> 可以轻松完成任务：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
arr<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 5</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>代码的语义会更直观更清爽，非常的方便！</p><p>支持类型：</p><ul><li><p>String</p></li><li><p>Array</p></li><li><p>Typed Array</p></li></ul><h2 id="_7-array-group" tabindex="-1"><a class="header-anchor" href="#_7-array-group" aria-hidden="true">#</a> 7. Array Group</h2><blockquote><p>用于数组元素分类</p></blockquote><p>给数组Array的原型上添加了两个方法，<code>groupBy</code>和<code>groupByToMap</code>。内容比较简单，直接看使用案例就可以看懂，这里不再赘述。</p><ul><li>groupBy</li></ul><p>使用案例：</p><p>将数组中的元素，按照数字 ‘40’ 来进行分类</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> array <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">56</span><span class="token punctuation">,</span> <span class="token number">78</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">]</span>
array<span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> item <span class="token operator">&gt;</span> <span class="token number">40</span> <span class="token operator">?</span> <span class="token string">&#39;比40大&#39;</span> <span class="token operator">:</span> <span class="token string">&quot;比40小&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// {&#39;比40大&#39;: [56, 78, 42, 49] , &#39;比40小&#39;: [23,11]}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><code>groupBy</code>方法返回了一个新的匿名对象，其中对象的键key为<code>groupBy</code>的回调函数的返回值。</p><p>如果没有<code>groupBy</code>提案，我们过去是这么实现：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">groupBy</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> key <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>object<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            object<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            object<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> object<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>groupByToMap</li></ul><p><code>groupByToMap</code>方法返回了一个常规的Map，其中Map的键key为<code>groupBy</code>的回调函数的返回值。</p><p>使用案例：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> array <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> odd  <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">odd</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> even <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">even</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
array<span class="token punctuation">.</span><span class="token function">groupByToMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">num<span class="token punctuation">,</span> index<span class="token punctuation">,</span> array</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> num <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">?</span> even<span class="token operator">:</span> odd<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// =&gt;  Map { {odd: true}: [1, 3, 5], {even: true}: [2, 4] }</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>如果没有<code>groupByToMap</code>提案，我们过去是这么实现：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">groupByToMap</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> mapObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> key <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>mapObject<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mapObject<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            mapObject<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> mapObject<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>评价</strong>：实际开发中，类似这样的数组 <code>[ 1 , 2 , 3 , 4 , 5 ]</code>，如果要分奇数偶数的话，需要重新声明一个对象来存储。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">odd</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">even</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>而<code>groupBy</code>提案返回的是一个<code>null-prototype</code>对象，<code>{ odd: [1, 3, 5], even: [2, 4] }</code>,不需要再声明一个具名对象。<code>groupByToMap</code>返回的是一个常规Map对象，总体来说比较实用。</p><h2 id="_8-array-find-from-last" tabindex="-1"><a class="header-anchor" href="#_8-array-find-from-last" aria-hidden="true">#</a> 8. Array find from last</h2><blockquote><p>从数组的最后一个到第一个查找元素的方法</p></blockquote><p>使用案例：</p><p>按照以前的js写法，要想倒叙查询数组元素。</p><p>先进行一次反转<code>reverse</code>，反转一次数组，再使用<code>find</code>进行查询。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> array <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">4</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token operator">...</span>array<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token operator">=&gt;</span> n<span class="token punctuation">.</span>value <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// { value: 3 }</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>或者在原型上挂一个方法来实现：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">findLast</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> len <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><code>Array find from last</code> 提案方案：</p><p>通过提案提供的方法<code>findLast</code>，支持了直接逆向查询数组。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>array<span class="token punctuation">.</span><span class="token function">findLast</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token operator">=&gt;</span> n<span class="token punctuation">.</span>value <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: 3 }</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>评价</strong>：从性能看，减少了一次数组反转，确实有看的见的优化。从语义上来说，有正向查询就应该有反向查询，符合人们的思维习惯，总体来说比较实用。</p><h2 id="_9-resizable-and-growable-array-buffer" tabindex="-1"><a class="header-anchor" href="#_9-resizable-and-growable-array-buffer" aria-hidden="true">#</a> 9. Resizable and growable Array Buffer</h2><blockquote><p>扩展<code>ArrayBuffer</code>构造函数，采用额外的最大长度，以允许就地增长和缩小缓冲区。</p></blockquote><p>在介绍提案之前，需要提前了解下什么是<code>ArrayBuffer</code>，它是解决什么问题的，怎么用，在哪里用。这样会方便理解该提案。以下介绍ArrayBuffer的内容我已经过滤了很多细枝末节的理论，希望能做到之前没有这方面基础的同学也可以一次性读懂<code>ArrayBuffer</code>。</p><p><code>Array Buffer</code>这个概念，大家在日常开发中几乎不会直接接触这个概念，但和我们关系却很密切。</p><p>简单理解<code>Array Buffer</code>，可以说它让ECMAScript操作内存空间成为可能。它的诞生是因为一个项目，WebGL，这个项目里需要浏览器与显卡进行频繁的通信，而以往的文本传输，需要把文本&#39;hello wrold&#39;，翻译01010111...类似这样的机器语言，非常消耗性能，而直接以二进制的形式通信就非常有必要了，Array Buffer也就此诞生；</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>这样创建了一段32字节的内存空间，buffer。有一些约定好的特性，比如生成的<code>ArrayBuffer</code>，不能被直接修改，需要通过 TypedArray视图和DataView视图修改，TypedArray就是一系列更改内存的构造函数统称，比如<code>Uint8Array</code>，<code>Uint16Array</code>，<code>Uint32Array</code>，DataView是更灵活的操作<code>ArrayBuffer</code>的视图。大概是因为最开始设计是为了解决图像绘制的问题，所以就起名叫各种视图，记住就ok了。</p><p>以下是<code>TypedArray</code>视图支持的一些数据类型</p><table><thead><tr><th>数据类型</th><th>字节长度</th><th>含义</th><th>对应的 C 语言类型</th></tr></thead><tbody><tr><td>Int8</td><td>1</td><td>8 位带符号整数</td><td>signed char</td></tr><tr><td>Int16</td><td>2</td><td>16 位带符号整数</td><td>short</td></tr><tr><td>Int32</td><td>4</td><td>32 位带符号整数</td><td>int</td></tr></tbody></table><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//生成12字节的内存空间</span>
<span class="token keyword">const</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//用Int32Array视图读取这个内存空间</span>
<span class="token keyword">const</span> x1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Int32Array</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//直接修改</span>
x1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//1</span>
<span class="token comment">//用Int8Array视图读取这个内存空间</span>
<span class="token keyword">const</span> x2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
x2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">//2</span>
<span class="token comment">//x1的值发生变化</span>
x1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// 2</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>上面代码对同一段内存，分别建立两种视图：32 位带符号整数（<code>Int32Array</code>构造函数）和 8 位不带符号整数（<code>Uint8Array</code>构造函数）。由于两个视图对应的是同一段内存，一个视图修改底层内存，会影响到另一个视图。</p><h3 id="arraybuffer-的一些理解" tabindex="-1"><a class="header-anchor" href="#arraybuffer-的一些理解" aria-hidden="true">#</a> ArrayBuffer 的一些理解</h3><p><code>Array Buffer</code>是一个二进制数组，也可以说是一个构造函数，但本质上是一个由一堆 <strong>0 1</strong> 组成的缓存空间，他在内存中主要发挥数据缓冲的作用。简单理解就是计算机要运行，就是cpu要处理 <strong>0 1</strong> 组成的二进制数据，但有时二进制数据来的又快又多，cpu还在处理其他任务，那这些数据就得原地等待，如果cpu处理任务很快，但是数据传输的慢了，就得让cpu空闲等待数据，造成资源浪费，ArrayBuffer就是充当一个缓冲内存空间。让这个内存空间随时数据存在，不会让数据和cpu等待。</p><h3 id="arraybuffer-遇到的瓶颈" tabindex="-1"><a class="header-anchor" href="#arraybuffer-遇到的瓶颈" aria-hidden="true">#</a> ArrayBuffer 遇到的瓶颈</h3><p>现有的<code>ArrayBuffer</code>存在一个问题，当你正在的<code>ArrayBuffer</code>空间不够需要增加空间时，需要调用ArrayBuffer原型上的一个方法，ArrayBuffer.prototype.slice()，使用如下</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> newBuffer <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>上面代码拷贝buffer对象的前 3 个字节（从 0 开始，到第 3 个字节前面结束），生成一个新的ArrayBuffer对象。</p><p>slice方法其实包含两步，第一步是先<code>分配一段新内存</code>，第二步是将原来那个ArrayBuffer对象<code>拷贝</code>过去。</p><h3 id="改造-arraybuffer" tabindex="-1"><a class="header-anchor" href="#改造-arraybuffer" aria-hidden="true">#</a> 改造 ArrayBuffer</h3><p>以上就介绍完了ArrayBuffer，和它目前面临的瓶颈。下面讲一下本次进入stage3的提案。</p><p>本提案拓展了ArrayBuffer的构造函数，增加最大和最小伸缩长度的配置---<code>maximumByteLength</code>。 重写了<code>transfer</code>方法，可以用来直接转移内存空间，不必再复制一份内存再挪动。</p><p>改造之后的<code>ArrayBuffer</code>构造函数</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">ArrayBuffer</span> <span class="token punctuation">{</span>
    <span class="token comment">//options为配置项 </span>
    <span class="token comment">//maximumByteLength 配置内存伸缩长度</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>byteLength<span class="token punctuation">,</span><span class="token punctuation">[</span> options <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//挪动内存</span>
    <span class="token function">transfer</span><span class="token punctuation">(</span>newByteLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//更改内存长度</span>
    <span class="token function">resize</span><span class="token punctuation">(</span>newByteLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//分离出一个不可调整大小的ArrayBuffer</span>
    <span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//判断是否可以伸缩</span>
    <span class="token function">resizable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//获取配置的最大内存长度</span>
    <span class="token function">maximumByteLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//获取当前内存长度</span>
    <span class="token function">byteLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>使用案例：</p><p>声明一个<strong>1024字节</strong>的内存，并把最大内存长度设置为<strong>1024的平方</strong></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//增加配置项，maximumByteLength，最大内存长度允许到1024的平方</span>
<span class="token keyword">let</span> rab <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">maximumByteLength</span><span class="token operator">:</span> <span class="token number">1024</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//当前内存长度 1024字节</span>
<span class="token function">assert</span><span class="token punctuation">(</span>rab<span class="token punctuation">.</span>byteLength <span class="token operator">===</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//最大长度 1024平方字节</span>
<span class="token function">assert</span><span class="token punctuation">(</span>rab<span class="token punctuation">.</span>maximumByteLength <span class="token operator">===</span> <span class="token number">1024</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//可以就地更改长度</span>
<span class="token function">assert</span><span class="token punctuation">(</span>rab<span class="token punctuation">.</span>resizable<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//更改内存长度</span>
rab<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>rab<span class="token punctuation">.</span>byteLength <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//内存长度发生变化</span>
<span class="token function">assert</span><span class="token punctuation">(</span>rab<span class="token punctuation">.</span>byteLength <span class="token operator">===</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><code>transfer</code>是对内存进行挪动</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> ab <span class="token operator">=</span> rab<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>上面是挪动从0开始的1024字节</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">assert</span><span class="token punctuation">(</span>rab<span class="token punctuation">.</span>byteLength <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">assert</span><span class="token punctuation">(</span>rab<span class="token punctuation">.</span>maximumByteLength <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>上面是原来的内存（rab）被分离，并清除内存。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 内存被转移到ab</span>
<span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>ab<span class="token punctuation">.</span>resizable<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">assert</span><span class="token punctuation">(</span>ab<span class="token punctuation">.</span>byteLength <span class="token operator">===</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>内存成功被转移到ab</p><h3 id="sharedarraybuffer" tabindex="-1"><a class="header-anchor" href="#sharedarraybuffer" aria-hidden="true">#</a> SharedArrayBuffer</h3><blockquote><p><code>SharedArrayBuffer</code> 顾名思义就是可以共享的ArrayBuffer</p></blockquote><p><code>ArrayBuffer</code>提案里，将<code>SharedArrayBuffer</code>也进行了改动，让他支持可以增长内存。</p><p>先简单介绍下什么是<code>SharedArrayBuffer</code>。</p><p>在ECMAScript里有一些计算任务通常会让在worker线程里，每个worker线程都是互相隔离的，他们之间的通信需要通过postMessage来完成。</p><p>除了可以进行字符串数外，也可以进行二进制数据通信，但需要将二进制数据复制一份再用过postMessage传递给另一个线程，数据量很大时效率会变低，所以在 <strong>es2017</strong> 时有人提出了可以共享的<code>SharedArrayBuffer</code>，js的主线程和worker线程可以共享这块内存空间，同时进行数据读写，避免了复制二进制数据带来的性能损耗。</p><p>实际场景里，在主线程创建了一个<code>SharedArrayBuffer</code>,并把内存地址通过<code>postMessage</code>发给<code>worker线程</code></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 主线程</span>
<span class="token comment">// 新建 1KB 共享内存</span>
<span class="token keyword">const</span> sharedBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedArrayBuffer</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 主线程将共享内存的地址发送出去</span>
w<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>sharedBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><code>worker线程</code>接受来自主线程的<code>共享地址</code> ---- <code>SharedArrayBuffer</code>，不必再复制同一份二进制地址进行传递。通过<code>共享地址</code>提高了性能。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// Worker 线程</span>
<span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 主线程共享的数据，就是 1KB 的共享内存</span>
  <span class="token keyword">const</span> sharedBuffer <span class="token operator">=</span> ev<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
  <span class="token comment">// 在共享内存上建立视图，方便读写</span>
  <span class="token keyword">const</span> sharedArray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Int32Array</span><span class="token punctuation">(</span>sharedBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><code>ArrayBuffer</code>提案对<code>SharedArrayBuffer</code>也进行了拓展，允许<code>SharedArrayBuffer</code>支持增加内存，但与<code>ArrayBuffer</code>不同的是，不支持减少内存，很显然，如果减少内存的话，很有可能影响到正在<code>共享</code>这块内存的其他程序。</p><p>下面是<code>SharedArrayBuffer</code>的构造函数。在<code>ArrayBuffer</code>构造函数里的<strong>resize</strong>，这里命名是<strong>grow</strong>，也能体现出两者的差异了。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">SharedArrayBuffer</span> <span class="token punctuation">{</span>
    <span class="token comment">//和ArrayBuffer一样配置maximumByteLength</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>byteLength<span class="token punctuation">,</span> <span class="token punctuation">[</span> options <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//只能增加内存，而不能缩短内存</span>
    <span class="token function">grow</span><span class="token punctuation">(</span>newByteLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//分离出一份不可增长的 SharedArrayBuffer。</span>
    <span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//判断是否可以扩充内存</span>
    <span class="token function">growable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//获取最大内存长度</span>
    <span class="token function">maximumByteLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//获取当前内存长度</span>
    <span class="token function">byteLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>目前 <code>ArrayBuffer</code> 提案遇到一个阻碍，真实场景中，可能存在多个线程需要扩大内存，按照现在的设计是需要先占用内存，再扩大或缩小至目标内存，但真实场景里，可能存在内存不够的情况，那么会造成资源抢夺。所以如何分配内存资源的问题仍需解决。</p><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: dean@57blocks.com">DeanSui</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/notes/assets/app.816e2a4d.js" defer></script>
  </body>
</html>
